<div class="layout-container">

  <div class="form-column">
    <mat-card>
      <mat-card-header>
        <mat-card-title>Data ophalen via Jira</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <form class="jira-form">
          <mat-form-field>
            <mat-label>Jira Server URL</mat-label>
            <input matInput [(ngModel)]="jiraUrl" name="jiraUrl">
          </mat-form-field>

          <mat-form-field>
            <mat-label>Jira Email</mat-label>
            <input matInput type="email" [(ngModel)]="jiraEmail" name="jiraEmail">
          </mat-form-field>

          <mat-form-field>
            <mat-label>Jira API Token</mat-label>
            <input matInput type="password" [(ngModel)]="jiraToken" name="jiraToken">
          </mat-form-field>
          
          <hr>

          <h4>Bouw je Query</h4>
          <mat-form-field>
            <mat-label>Project Key</mat-label>
            <input matInput [(ngModel)]="projectKey" name="projectKey">
          </mat-form-field>

          <mat-form-field>
            <mat-label>Status</mat-label>
            <mat-select [(ngModel)]="selectedStatuses" name="selectedStatuses" multiple>
              <mat-option *ngFor="let status of availableStatuses" [value]="status">{{status}}</mat-option>
            </mat-select>
          </mat-form-field>
          
          <mat-form-field>
            <mat-label>Velden om op te halen</mat-label>
            <mat-select [(ngModel)]="selectedFields" name="selectedFields" multiple>
              <mat-option *ngFor="let field of availableFields" [value]="field">{{field}}</mat-option>
            </mat-select>
          </mat-form-field>
        </form>
      </mat-card-content>
      <mat-card-actions>
        <button mat-raised-button color="primary" (click)="onFetchData()">Haal Data Op</button>
      </mat-card-actions>
      <mat-card-footer *ngIf="statusMessage">
        <p>{{ statusMessage }}</p>
      </mat-card-footer>
    </mat-card>
  </div>

  <div class="results-column" *ngIf="issues.length > 0">
    <h3>Opgehaalde Issues</h3>
  
    <table mat-table [dataSource]="issues" class="mat-elevation-z2">
  
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef>
          <mat-checkbox (change)="$event ? masterToggle() : null"
                        [checked]="selection.hasValue() && isAllSelected()">
          </mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let row">
          <mat-checkbox (click)="$event.stopPropagation()"
                        (change)="$event ? selection.toggle(row) : null"
                        [checked]="selection.isSelected(row)">
          </mat-checkbox>
        </td>
      </ng-container>
  
      <ng-container matColumnDef="key">
        <th mat-header-cell *matHeaderCellDef> Key </th>
        <td mat-cell *matCellDef="let issue"> {{issue.key}} </td>
      </ng-container>

      <ng-container matColumnDef="summary">
        <th mat-header-cell *matHeaderCellDef> Samenvatting </th>
        <td mat-cell *matCellDef="let issue"> {{issue.fields.summary}} </td>
      </ng-container>

      <ng-container matColumnDef="description">
        <th mat-header-cell *matHeaderCellDef> Beschrijving </th>
        <td mat-cell *matCellDef="let issue"> {{issue.fields.description | slice:0:100}}... </td>
      </ng-container>

      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef> Status </th>
        <td mat-cell *matCellDef="let issue"> {{issue.fields.status.name}} </td>
      </ng-container>
      
      <ng-container matColumnDef="issuetype">
        <th mat-header-cell *matHeaderCellDef> Type </th>
        <td mat-cell *matCellDef="let issue"> {{issue.fields.issuetype.name}} </td>
      </ng-container>

      <ng-container matColumnDef="reporter">
        <th mat-header-cell *matHeaderCellDef> Reporter </th>
        <td mat-cell *matCellDef="let issue"> {{issue.fields.reporter.displayName}} </td>
      </ng-container>

      <ng-container matColumnDef="assignee">
        <th mat-header-cell *matHeaderCellDef> Assignee </th>
        <td mat-cell *matCellDef="let issue"> {{issue.fields.assignee?.displayName || 'Unassigned'}} </td>
      </ng-container>

      <ng-container matColumnDef="priority">
        <th mat-header-cell *matHeaderCellDef> Prioriteit </th>
        <td mat-cell *matCellDef="let issue"> {{issue.fields.priority.name}} </td>
      </ng-container>

      <ng-container matColumnDef="labels">
        <th mat-header-cell *matHeaderCellDef> Labels </th>
        <td mat-cell *matCellDef="let issue"> {{issue.fields.labels.join(', ')}} </td>
      </ng-container>

      <ng-container matColumnDef="timespent">
        <th mat-header-cell *matHeaderCellDef> Bestede Tijd (u) </th>
        <td mat-cell *matCellDef="let issue"> {{(issue.fields.timespent / 3600).toFixed(1)}} </td>
      </ng-container>

      <ng-container matColumnDef="customfield_10035">
        <th mat-header-cell *matHeaderCellDef> Story Points </th>
        <td mat-cell *matCellDef="let issue"> {{issue.fields.customfield_10035 || 'N/A'}} </td>
      </ng-container>
  
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>
  
    <div class="actions-footer" *ngIf="issues.length > 0">
      <button mat-raised-button color="accent" 
              [disabled]="!selection.hasValue()"
              (click)="prepareSelectedData()">
        Bereid {{selection.selected.length}} geselecteerde issue(s) voor
      </button>
    </div>
  </div>

</div>